<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Gym-Planer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #101010;
      --bg-card: #181818;
      --bg-card-alt: #202020;
      --accent: #3dd8a3;
      --accent-soft: rgba(61, 216, 163, 0.12);
      --text: #f5f5f5;
      --text-muted: #aaaaaa;
      --danger: #ff6b6b;
      --border: #333333;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 35px rgba(0, 0, 0, 0.5);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px 12px 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #181818 0, #050505 60%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    .app {
      max-width: 520px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.4rem;
      margin: 0 0 10px;
      font-weight: 650;
      letter-spacing: 0.02em;
      text-align: center;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 14px 14px 16px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255, 255, 255, 0.03);
      margin-bottom: 14px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    /* Zentrierte Titel nur für Zeitfenster & Zeitplan */
    #timeSection .card-header,
    #planSection .card-header {
      justify-content: center;
    }

    #timeSection .card-title,
    #planSection .card-title {
      text-align: center;
      width: 100%;
    }

    .flex-row {
      display: flex;
      gap: 10px;
    }

    .flex-1 {
      flex: 1;
    }

    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: var(--text-muted);
    }

    .center-label {
      text-align: center;
    }

    /* Basis-Inputs */
    input[type="time"],
    input[type="number"],
    input[type="text"] {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--bg-card-alt);
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      display: block;
    }

    /* Time: native Control, aber visuell wie die anderen */
    input[type="time"] {
      -webkit-appearance: none;
      appearance: none;
      padding: 0 10px;
      height: 40px;
      line-height: 40px;
      text-align: center;
    }

    /* Number/Text */
    input[type="number"],
    input[type="text"] {
      padding: 6px 10px;
      height: 36px;
    }

    input[type="time"]:focus,
    input[type="number"]:focus,
    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .time-input {
      max-width: 140px;
      margin: 0 auto;
      text-align: center;
    }

    .checkbox-row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }

    .checkbox {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
      flex: 1;
    }

    .checkbox input {
      accent-color: var(--accent);
      width: 18px;
      height: 18px;
    }

    .sauna-inline-row {
      display: none;
      margin-top: 8px;
      gap: 10px;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .inline-input {
      max-width: 120px;
      margin: 0 auto;
      text-align: center;
      display: block;
    }

    .sauna-sessions {
      margin-top: 6px;
      display: none;
      flex-direction: column;
      gap: 4px;
    }

    .sauna-session-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .sauna-session-label {
      min-width: 70px;
    }

    .sauna-session-row .inline-input {
      max-width: 80px;
    }

    button {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      background: linear-gradient(135deg, var(--accent), #2ba57a);
      color: #020202;
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.6);
    }

    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.7);
    }

    .primary-button {
      margin-top: 20px;
    }

    .small-button {
      width: auto;
      padding: 6px 10px;
      font-size: 0.75rem;
      text-transform: none;
      letter-spacing: 0;
      margin: 0;
      background: transparent;
      color: var(--text-muted);
      box-shadow: none;
      border-radius: 999px;
      border: 1px solid var(--border);
    }

    .small-button:active {
      transform: none;
      box-shadow: none;
      background: rgba(255, 255, 255, 0.04);
    }

    .settings-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--text-muted);
      cursor: pointer;
      user-select: none;
    }

    .settings-toggle-icon {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .settings-body {
      margin-top: 10px;
      border-top: 1px solid var(--border);
      padding-top: 10px;
      display: none;
    }

    .settings-groups {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .settings-group-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #dddddd;
      margin-bottom: 4px;
    }

    .settings-group {
      padding-bottom: 4px;
      border-bottom: 1px dashed rgba(255, 255, 255, 0.08);
    }

    .settings-group:last-child {
      border-bottom: none;
    }

    .settings-field {
      margin-bottom: 6px;
    }

    .settings-footer {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .settings-note {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .ratio-row {
      margin-top: 10px;
    }

    .ratio-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 6px;
      gap: 4px;
      text-align: center;
    }

    .accent-text {
      color: var(--accent);
      font-weight: 500;
    }

    input[type="range"] {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      border-radius: 999px;
      background: #333;
      outline: none;
      margin-top: 2px;
      margin-bottom: 4px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 7px var(--accent-soft);
      cursor: pointer;
      border: none;
    }

    input[type="range"]::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      box-shadow: 0 0 0 7px var(--accent-soft);
      cursor: pointer;
    }

    .message {
      margin-top: 8px;
      font-size: 0.8rem;
    }

    .message.error {
      color: var(--danger);
    }

    .message.info {
      color: var(--text-muted);
    }

    .output-card {
      margin-top: 6px;
      background: linear-gradient(145deg, var(--bg-card), #111111);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 10px 12px 12px;
    }

    .timeline {
      list-style: none;
      margin: 0;
      padding: 0;
      font-size: 0.86rem;
    }

    .timeline-item {
      display: flex;
      align-items: baseline;
      gap: 8px;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(255, 255, 255, 0.05);
      border-left: 3px solid rgba(255, 255, 255, 0.16);
      padding-left: 8px;
      transition: margin-top 0.1s ease, padding-top 0.1s ease;
    }

    .timeline-item:last-child {
      border-bottom: none;
    }

    .timeline-item.group-start {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.12);
    }

    .timeline-header {
      margin-top: 10px;
      padding-top: 6px;
      padding-bottom: 2px;
      font-size: 0.78rem;
      font-weight: 600;
      color: #dddddd;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
    }

    .time {
      font-feature-settings: "tnum" 1, "lnum" 1;
      font-variant-numeric: tabular-nums;
      min-width: 52px;
      color: var(--accent);
      font-weight: 500;
    }

    .label {
      flex: 1;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 0.8rem;
      color: var(--text-muted);
      flex-wrap: wrap;
      gap: 4px;
    }

    .summary-highlight {
      color: var(--accent);
      font-weight: 500;
    }

    /* Toast / Bubble Overlay */
    .toast-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 999;
      background: radial-gradient(circle at center, rgba(0, 0, 0, 0.4), transparent 55%);
    }

    .toast-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .toast-bubble {
      background: rgba(15, 15, 15, 0.96);
      padding: 14px 22px;
      border-radius: 999px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 90%;
    }

    .toast-icon {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: var(--accent);
    }

    @media (max-width: 380px) {
      body {
        padding: 12px 8px 20px;
      }
      .card {
        padding: 12px;
      }
      .flex-row {
        flex-direction: column;
      }
      .sauna-inline-row {
        flex-direction: column;
      }
      .time-input {
        max-width: 100%;
      }
      .inline-input {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Gym-Planer</h1>
    </header>

    <!-- Haupt-Eingaben -->
    <section class="card" id="timeSection">
      <div class="card-header">
        <div class="card-title">Zeitfenster</div>
      </div>

      <div class="flex-row">
        <div class="flex-1">
          <label for="startTime" class="center-label">Abfahrt</label>
          <input type="time" id="startTime" class="time-input" required>
        </div>
        <div class="flex-1">
          <label for="endTime" class="center-label">Zuhause</label>
          <input type="time" id="endTime" class="time-input" required>
        </div>
      </div>

      <div class="checkbox-row">
        <label class="checkbox">
          <input type="checkbox" id="cardioEnabled" checked>
          <span>Cardio einplanen</span>
        </label>
        <label class="checkbox">
          <input type="checkbox" id="saunaEnabled">
          <span>Sauna einplanen</span>
        </label>
      </div>

      <!-- Sauna Inline-Dauer + Anzahl -->
      <div class="sauna-inline-row" id="saunaInlineRow">
        <div class="flex-1">
          <label for="saunaDurationInline" class="center-label">Sauna (min)</label>
          <input type="number" id="saunaDurationInline" min="0" inputmode="numeric" class="inline-input">
        </div>
        <div class="flex-1">
          <label for="relaxDurationInline" class="center-label">Relax (min)</label>
          <input type="number" id="relaxDurationInline" min="0" inputmode="numeric" class="inline-input">
        </div>
        <div class="flex-1">
          <label for="saunaCountInline" class="center-label">Gänge</label>
          <input type="number" id="saunaCountInline" min="1" inputmode="numeric" class="inline-input">
        </div>
      </div>

      <div class="sauna-sessions" id="saunaSessionsContainer"></div>

      <!-- Verhältnis-Slider -->
      <div class="ratio-row" id="ratioRow">
        <div class="ratio-label">
          <span>Verhältnis Kraft / Cardio</span>
          <span id="ratioInfo">erst nach der ersten Berechnung sinnvoll nutzbar</span>
        </div>
        <input type="range" id="ratioSlider" min="0" max="60" step="5" value="30">
      </div>

      <button id="planButton" class="primary-button" type="button" onclick="calculatePlan()">Plan berechnen</button>
      <div id="mainMessage" class="message"></div>
    </section>

    <!-- Ausgabe -->
    <section class="card" id="planSection">
      <div class="card-header">
        <div class="card-title">Zeitplan</div>
      </div>

      <div id="planOutput" class="output-card">
        <div class="message info">Noch kein Plan berechnet. Starte oben mit Abfahrt & Zuhause-Zeit.</div>
      </div>
    </section>

    <!-- Einstellungen -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Einstellungen</div>
        </div>
        <div class="settings-toggle" id="settingsToggle">
          <div class="settings-toggle-icon" id="settingsToggleIcon">+</div>
          <span>Einstellungen öffnen</span>
        </div>
      </div>

      <div class="settings-body" id="settingsBody">
        <div class="settings-groups">
          <div class="settings-group">
            <div class="settings-group-title">Fahrten</div>
            <div class="settings-field">
              <label for="driveTo">Fahrt ins Gym (min)</label>
              <input type="number" id="driveTo" min="0" inputmode="numeric">
            </div>
            <div class="settings-field">
              <label for="driveBack">Heimfahrt (min)</label>
              <input type="number" id="driveBack" min="0" inputmode="numeric">
            </div>
          </div>

          <div class="settings-group">
            <div class="settings-group-title">Kleidungswechsel</div>
            <div class="settings-field">
              <label for="changeBefore">Umziehen vor Training (min)</label>
              <input type="number" id="changeBefore" min="0" inputmode="numeric">
            </div>
            <div class="settings-field">
              <label for="changeAfter">Umziehen nach Training (min)</label>
              <input type="number" id="changeAfter" min="0" inputmode="numeric">
            </div>
          </div>

          <div class="settings-group">
            <div class="settings-group-title">Training</div>
            <div class="settings-field">
              <label for="breakBetween">Pause zwischen Kraft und Cardio (min)</label>
              <input type="number" id="breakBetween" min="0" inputmode="numeric">
            </div>
          </div>

          <div class="settings-group">
            <div class="settings-group-title">Saunagang</div>
            <div class="settings-field">
              <label for="saunaDuration">Dauer Saunagang (Standard, min)</label>
              <input type="number" id="saunaDuration" min="0" inputmode="numeric">
            </div>
            <div class="settings-field">
              <label for="relaxDuration">Relax (Standard, min)</label>
              <input type="number" id="relaxDuration" min="0" inputmode="numeric">
            </div>
          </div>

          <div class="settings-group">
            <div class="settings-group-title">Duschgänge</div>
            <div class="settings-field">
              <label for="preSaunaShower">Abduschen vor Sauna (min)</label>
              <input type="number" id="preSaunaShower" min="0" inputmode="numeric">
            </div>
            <div class="settings-field">
              <label for="postSaunaShower">Abduschen nach Saunagang (min)</label>
              <input type="number" id="postSaunaShower" min="0" inputmode="numeric">
            </div>
            <div class="settings-field">
              <label for="showerAfter">Duschen nach Training (und Sauna) (min)</label>
              <input type="number" id="showerAfter" min="0" inputmode="numeric">
            </div>
          </div>
        </div>

        <div class="settings-footer">
          <button class="small-button" id="resetDefaults" type="button">Standardwerte laden</button>
          <button class="small-button" id="saveSettings" type="button">Einstellungen speichern</button>
          <div class="settings-note">
            Werte werden lokal auf deinem Gerät gespeichert.
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Toast / Bubble Overlay -->
  <div id="toastOverlay" class="toast-overlay">
    <div class="toast-bubble">
      <span class="toast-icon">✔</span>
      <span id="toastMessage">Einstellungen gespeichert</span>
    </div>
  </div>

  <script>
    const defaultSettings = {
      driveTo: 10,
      driveBack: 10,
      changeBefore: 5,
      preSaunaShower: 5,
      saunaDuration: 15,
      postSaunaShower: 5,
      relaxDuration: 15,
      showerAfter: 5,
      changeAfter: 10,
      breakBetween: 5
    };

    const SETTINGS_KEY = "gymPlannerSettings_v1";

    const els = {
      startTime: document.getElementById("startTime"),
      endTime: document.getElementById("endTime"),
      cardioEnabled: document.getElementById("cardioEnabled"),
      saunaEnabled: document.getElementById("saunaEnabled"),
      saunaInlineRow: document.getElementById("saunaInlineRow"),
      saunaDurationInline: document.getElementById("saunaDurationInline"),
      relaxDurationInline: document.getElementById("relaxDurationInline"),
      saunaCountInline: document.getElementById("saunaCountInline"),
      saunaSessionsContainer: document.getElementById("saunaSessionsContainer"),
      ratioRow: document.getElementById("ratioRow"),
      ratioSlider: document.getElementById("ratioSlider"),
      ratioInfo: document.getElementById("ratioInfo"),
      planButton: document.getElementById("planButton"),
      mainMessage: document.getElementById("mainMessage"),
      planOutput: document.getElementById("planOutput"),
      settingsToggle: document.getElementById("settingsToggle"),
      settingsToggleIcon: document.getElementById("settingsToggleIcon"),
      settingsBody: document.getElementById("settingsBody"),
      driveTo: document.getElementById("driveTo"),
      driveBack: document.getElementById("driveBack"),
      changeBefore: document.getElementById("changeBefore"),
      preSaunaShower: document.getElementById("preSaunaShower"),
      saunaDuration: document.getElementById("saunaDuration"),
      postSaunaShower: document.getElementById("postSaunaShower"),
      relaxDuration: document.getElementById("relaxDuration"),
      showerAfter: document.getElementById("showerAfter"),
      changeAfter: document.getElementById("changeAfter"),
      breakBetween: document.getElementById("breakBetween"),
      saveSettings: document.getElementById("saveSettings"),
      resetDefaults: document.getElementById("resetDefaults")
    };

    const toastOverlay = document.getElementById("toastOverlay");
    const toastMessage = document.getElementById("toastMessage");
    let toastDismissCallback = null;
    let toastTimeout = null;

    let currentSettings = { ...defaultSettings };
    let lastPlan = null;

    function toInt(value, fallback) {
      const n = parseInt(value, 10);
      return Number.isFinite(n) && n >= 0 ? n : fallback;
    }

    function parseTimeToMinutes(value) {
      if (!value || !/^\d{2}:\d{2}$/.test(value)) return null;
      const [hStr, mStr] = value.split(":");
      const h = parseInt(hStr, 10);
      const m = parseInt(mStr, 10);
      if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
      if (h < 0 || h > 23 || m < 0 || m > 59) return null;
      return h * 60 + m;
    }

    function formatMinutesToTime(mins) {
      const day = 24 * 60;
      mins = ((mins % day) + day) % day;
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      const hh = h.toString().padStart(2, "0");
      const mm = m.toString().padStart(2, "0");
      return hh + ":" + mm;
    }

    function loadSettings() {
      try {
        const stored = localStorage.getItem(SETTINGS_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          currentSettings = { ...defaultSettings, ...parsed };
        }
      } catch (e) {
        console.warn("Konnte Einstellungen nicht laden:", e);
      }
      applySettingsToInputs();
    }

    function saveSettings() {
      const s = {
        driveTo: toInt(els.driveTo.value, defaultSettings.driveTo),
        driveBack: toInt(els.driveBack.value, defaultSettings.driveBack),
        changeBefore: toInt(els.changeBefore.value, defaultSettings.changeBefore),
        preSaunaShower: toInt(els.preSaunaShower.value, defaultSettings.preSaunaShower),
        saunaDuration: toInt(els.saunaDuration.value, defaultSettings.saunaDuration),
        postSaunaShower: toInt(els.postSaunaShower.value, defaultSettings.postSaunaShower),
        relaxDuration: toInt(els.relaxDuration.value, defaultSettings.relaxDuration),
        showerAfter: toInt(els.showerAfter.value, defaultSettings.showerAfter),
        changeAfter: toInt(els.changeAfter.value, defaultSettings.changeAfter),
        breakBetween: toInt(els.breakBetween.value, defaultSettings.breakBetween)
      };
      currentSettings = s;
      try {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
      } catch (e) {
        console.warn("Konnte Einstellungen nicht speichern:", e);
      }
    }

    function applySettingsToInputs() {
      els.driveTo.value = currentSettings.driveTo;
      els.driveBack.value = currentSettings.driveBack;
      els.changeBefore.value = currentSettings.changeBefore;
      els.preSaunaShower.value = currentSettings.preSaunaShower;
      els.saunaDuration.value = currentSettings.saunaDuration;
      els.postSaunaShower.value = currentSettings.postSaunaShower;
      els.relaxDuration.value = currentSettings.relaxDuration;
      els.showerAfter.value = currentSettings.showerAfter;
      els.changeAfter.value = currentSettings.changeAfter;
      els.breakBetween.value = currentSettings.breakBetween;
    }

    function resetDefaults() {
      currentSettings = { ...defaultSettings };
      applySettingsToInputs();
      try {
        localStorage.removeItem(SETTINGS_KEY);
      } catch (e) {
        console.warn("Konnte Einstellungen nicht löschen:", e);
      }
      showMainMessage("Standardwerte geladen.", "info");
    }

    function setDefaultTimes() {
      const now = new Date();
      const minsNow = now.getHours() * 60 + now.getMinutes();
      let startMins = minsNow + 15;
      const quarter = 15;
      startMins = Math.ceil(startMins / quarter) * quarter;
      const endMins = startMins + 150; // 2,5 h

      els.startTime.value = formatMinutesToTime(startMins);
      els.endTime.value = formatMinutesToTime(endMins);
    }

    function showMainMessage(text, type) {
      els.mainMessage.textContent = text || "";
      els.mainMessage.className = "message " + (type || "");
    }

    function showToast(message, onDone) {
      toastMessage.textContent = message;
      toastDismissCallback = typeof onDone === "function" ? onDone : null;
      if (toastTimeout) {
        clearTimeout(toastTimeout);
        toastTimeout = null;
      }
      toastOverlay.classList.add("visible");
      toastTimeout = setTimeout(() => {
        hideToast();
      }, 2000);
    }

    function hideToast() {
      toastOverlay.classList.remove("visible");
      if (toastTimeout) {
        clearTimeout(toastTimeout);
        toastTimeout = null;
      }
      if (toastDismissCallback) {
        const cb = toastDismissCallback;
        toastDismissCallback = null;
        cb();
      }
    }

    toastOverlay.addEventListener("click", function () {
      hideToast();
    });

    function updateSaunaSessionsUI() {
      const container = els.saunaSessionsContainer;
      if (!els.saunaEnabled.checked) {
        container.style.display = "none";
        container.innerHTML = "";
        return;
      }

      const count = toInt(els.saunaCountInline.value, 1);
      if (count <= 1) {
        container.style.display = "none";
        container.innerHTML = "";
        return;
      }

      const baseSauna = toInt(els.saunaDurationInline.value, currentSettings.saunaDuration);
      const baseRelax = toInt(els.relaxDurationInline.value, currentSettings.relaxDuration);

      let html = "";
      for (let i = 1; i <= count; i++) {
        html +=
          '<div class="sauna-session-row">' +
            '<span class="sauna-session-label">Gang ' + i + ':</span>' +
            '<span>Sauna</span>' +
            '<input type="number" class="inline-input" id="saunaDur_' + i + '" min="0" inputmode="numeric" value="' + baseSauna + '">' +
            '<span>Relax</span>' +
            '<input type="number" class="inline-input" id="relaxDur_' + i + '" min="0" inputmode="numeric" value="' + baseRelax + '">' +
          '</div>';
      }

      container.innerHTML = html;
      container.style.display = "flex";

      Array.from(container.querySelectorAll("input")).forEach(inp => {
        inp.addEventListener("focus", () => {
          setTimeout(() => inp.select(), 10);
        });
        inp.addEventListener("input", () => {
          if (lastPlan) calculatePlan();
        });
      });
    }

    function calculatePlan() {
      showMainMessage("", "");
      els.planOutput.innerHTML = "";

      const start = parseTimeToMinutes(els.startTime.value);
      const end = parseTimeToMinutes(els.endTime.value);

      if (start === null || end === null) {
        showMainMessage("Bitte Abfahrtszeit und Zuhause-Zeit im Format HH:MM eingeben.", "error");
        els.planOutput.innerHTML = '<div class="message error">Keine gültigen Zeiten – Plan konnte nicht berechnet werden.</div>';
        return;
      }

      let total = end - start;
      if (total <= 0) {
        total += 24 * 60;
      }

      const s = currentSettings;
      const cardio = els.cardioEnabled.checked;
      const sauna = els.saunaEnabled.checked;

      const fixBefore = s.driveTo + s.changeBefore;

      let saunaDurationEffective = s.saunaDuration;
      let relaxDurationEffective = s.relaxDuration;
      let saunaCount = 1;
      let saunaDurations = [];
      let relaxDurations = [];

      if (sauna) {
        saunaDurationEffective = toInt(els.saunaDurationInline.value, s.saunaDuration);
        relaxDurationEffective = toInt(els.relaxDurationInline.value, s.relaxDuration);
        saunaCount = toInt(els.saunaCountInline.value, 1);
        if (saunaCount < 1) saunaCount = 1;

        const container = els.saunaSessionsContainer;
        if (container && container.children.length && saunaCount > 1) {
          for (let i = 1; i <= saunaCount; i++) {
            const sdInput = document.getElementById("saunaDur_" + i);
            const rdInput = document.getElementById("relaxDur_" + i);
            saunaDurations.push(
              sdInput ? toInt(sdInput.value, saunaDurationEffective) : saunaDurationEffective
            );
            relaxDurations.push(
              rdInput ? toInt(rdInput.value, relaxDurationEffective) : relaxDurationEffective
            );
          }
        } else {
          for (let i = 0; i < saunaCount; i++) {
            saunaDurations.push(saunaDurationEffective);
            relaxDurations.push(relaxDurationEffective);
          }
        }
      }

      let fixAfter;
      if (sauna) {
        let saunaRelaxSum = 0;
        for (let i = 0; i < saunaCount; i++) {
          saunaRelaxSum += saunaDurations[i] + relaxDurations[i];
        }
        fixAfter =
          s.preSaunaShower +
          saunaRelaxSum +
          saunaCount * s.postSaunaShower +
          s.showerAfter +
          s.changeAfter +
          s.driveBack;
      } else {
        fixAfter = s.showerAfter + s.changeAfter + s.driveBack;
      }

      const trainingBudget = total - fixBefore - fixAfter;

      if (trainingBudget <= 0) {
        showMainMessage(
          "Dein Zeitfenster ist zu knapp. Verringere Fahrzeiten/Sauna oder verschiebe Abfahrt/Zuhause.",
          "error"
        );
        els.planOutput.innerHTML =
          '<div class="message error">Benötigte Fixzeiten sind länger als dein gesamtes Zeitfenster.</div>';
        return;
      }

      const sliderMax = Math.max(5, Math.floor(trainingBudget / 5) * 5);
      els.ratioSlider.max = sliderMax;
      let sliderValue = parseInt(els.ratioSlider.value, 10);
      if (!Number.isFinite(sliderValue) || sliderValue < 0 || sliderValue > sliderMax) {
        sliderValue = Math.floor(sliderMax / 2 / 5) * 5;
        els.ratioSlider.value = sliderValue;
      }

      lastPlan = {
        start,
        end,
        trainingBudget,
        cardio,
        sauna,
        settings: {
          ...s,
          saunaDurationEffective,
          relaxDurationEffective,
          saunaCount,
          saunaDurations,
          relaxDurations
        }
      };

      renderPlan();
    }

    function renderPlan() {
      if (!lastPlan) return;

      const { start, trainingBudget, cardio, sauna, settings: s } = lastPlan;

      let strengthRaw = parseInt(els.ratioSlider.value, 10);
      if (!Number.isFinite(strengthRaw) || strengthRaw < 0) strengthRaw = 0;
      if (strengthRaw > trainingBudget) strengthRaw = trainingBudget;

      let strengthMinutes, cardioMinutes, breakBetween;
      let trainingTimeSegments;

      if (!cardio) {
        // nur Kraft
        breakBetween = 0;
        strengthMinutes = trainingBudget;
        cardioMinutes = 0;
        trainingTimeSegments = trainingBudget;
        els.ratioSlider.disabled = true;
        els.ratioInfo.innerHTML =
          "Nur Kraft: <span class=\"accent-text\">" + trainingTimeSegments + " min</span>";
      } else {
        // Cardio an
        let cardioRaw = trainingBudget - strengthRaw;

        if (strengthRaw <= 0) {
          // nur Cardio
          breakBetween = 0;
          strengthMinutes = 0;
          cardioMinutes = trainingBudget;
          trainingTimeSegments = trainingBudget;
          els.ratioSlider.disabled = false;
          els.ratioInfo.innerHTML =
            "Nur Cardio: <span class=\"accent-text\">" + trainingTimeSegments + " min</span>";
        } else if (cardioRaw <= 0) {
          // nur Kraft
          breakBetween = 0;
          strengthMinutes = trainingBudget;
          cardioMinutes = 0;
          trainingTimeSegments = trainingBudget;
          els.ratioSlider.disabled = false;
          els.ratioInfo.innerHTML =
            "Nur Kraft: <span class=\"accent-text\">" + trainingTimeSegments + " min</span>";
        } else {
          // beide aktiv -> Pause zwischen Kraft & Cardio einplanen
          breakBetween = s.breakBetween || 0;
          const segmentsBudget = trainingBudget - breakBetween;
          if (segmentsBudget <= 0) {
            showMainMessage(
              "Zeitfenster zu knapp für die Pause zwischen Kraft und Cardio.",
              "error"
            );
            els.planOutput.innerHTML =
              '<div class="message error">Zeitfenster zu knapp für Trainings-Pause.</div>';
            return;
          }

          const ratio = strengthRaw / trainingBudget;
          strengthMinutes = Math.round((segmentsBudget * ratio) / 5) * 5;
          if (strengthMinutes < 0) strengthMinutes = 0;
          if (strengthMinutes > segmentsBudget) strengthMinutes = segmentsBudget;
          cardioMinutes = segmentsBudget - strengthMinutes;

          trainingTimeSegments = segmentsBudget;
          els.ratioSlider.disabled = false;
          els.ratioInfo.innerHTML =
            "Kraft: <span class=\"accent-text\">" + strengthMinutes + " min</span> · " +
            "Cardio: <span class=\"accent-text\">" + cardioMinutes + " min</span>";
        }
      }

      let t = start;
      const steps = [];

      function addHeader(label) {
        steps.push({ header: true, label });
      }

      function add(label, groupKey) {
        steps.push({
          time: formatMinutesToTime(t),
          label,
          group: groupKey || null
        });
      }

      // Hinfahrt
      add("Abfahrt", "drive-out");
      t += s.driveTo;

      add("Ankunft im Gym", "drive-out");
      t += s.changeBefore;

      if (trainingTimeSegments > 0) {
        addHeader("Training");
      }

      // Kraft
      if (strengthMinutes > 0) {
        add("Beginn Kraft-Training", "strength");
        t += strengthMinutes;
        add("Ende Kraft-Training", "strength");
      }

      // Pause zwischen Kraft & Cardio
      if (strengthMinutes > 0 && cardioMinutes > 0 && (s.breakBetween || 0) > 0) {
        add("Pause zwischen Kraft & Cardio", "training-break");
        t += s.breakBetween;
      }

      // Cardio
      if (cardioMinutes > 0) {
        add("Beginn Cardio-Training", "cardio");
        t += cardioMinutes;
        add("Ende Cardio-Training", "cardio");
      }

      // Sauna
      if (sauna && s.saunaCount > 0) {
        addHeader("Sauna");

        const count = s.saunaCount;

        add("Abduschen vor Sauna", "sauna-1");
        t += s.preSaunaShower;

        add("Beginn Saunagang 1", "sauna-1");
        t += s.saunaDurations[0] ?? s.saunaDurationEffective;
        add("Ende Saunagang 1", "sauna-1");

        add("Abduschen nach Saunagang 1", "sauna-relax-1");
        t += s.postSaunaShower;

        add("Beginn Relax 1", "sauna-relax-1");
        t += s.relaxDurations[0] ?? s.relaxDurationEffective;
        add("Ende Relax 1", "sauna-relax-1");

        for (let i = 2; i <= count; i++) {
          const idx = i - 1;
          const gSauna = "sauna-session-" + i;
          const gRelax = "sauna-relax-" + i;

          add("Beginn Saunagang " + i, gSauna);
          t += s.saunaDurations[idx] ?? s.saunaDurationEffective;
          add("Ende Saunagang " + i, gSauna);

          add("Abduschen nach Saunagang " + i, gRelax);
          t += s.postSaunaShower;

          add("Beginn Relax " + i, gRelax);
          t += s.relaxDurations[idx] ?? s.relaxDurationEffective;
          add("Ende Relax " + i, gRelax);
        }
      }

      // Abschluss
      addHeader("Abschluss");

      add("Duschen nach Training", "finish-clean");
      t += s.showerAfter;

      add("Anziehen nach Training", "finish-clean");
      t += s.changeAfter;

      add("Abfahrt nach Hause", "finish-home");
      t += s.driveBack;

      add("Zuhause", "finish-home");

      const saunaSummary = lastPlan.sauna
        ? (s.saunaCount === 1
            ? "Ja (1 Gang)"
            : "Ja (" + s.saunaCount + " Gänge)")
        : "Nein";

      const summaryHtml =
        '<div class="summary-row">' +
          '<span>Trainingszeit gesamt:</span>' +
          '<span class="summary-highlight">' + trainingTimeSegments + ' min</span>' +
        '</div>' +
        '<div class="summary-row">' +
          '<span>Kraft / Cardio (min):</span>' +
          '<span class="summary-highlight">' + strengthMinutes + ' / ' + cardioMinutes + '</span>' +
        '</div>' +
        '<div class="summary-row">' +
          '<span>Sauna eingeplant:</span>' +
          '<span class="summary-highlight">' + saunaSummary + '</span>' +
        '</div>';

      let html = '<div class="output-card">' + summaryHtml + '<ul class="timeline">';

      let prevGroup = null;
      for (let i = 0; i < steps.length; i++) {
        const step = steps[i];

        if (step.header) {
          html += '<li class="timeline-header">' + step.label + '</li>';
          continue;
        }

        const isGroupStart = step.group && step.group !== prevGroup;
        const groupClass = isGroupStart ? " group-start" : "";
        prevGroup = step.group || prevGroup;

        html +=
          '<li class="timeline-item' + groupClass + '">' +
            '<span class="time">' + step.time + '</span>' +
            '<span class="label">' + step.label + '</span>' +
          '</li>';
      }
      html += "</ul></div>";

      els.planOutput.innerHTML = html;
    }

    // Events
    els.planButton.addEventListener("click", function () {
      calculatePlan();
    });

    els.ratioSlider.addEventListener("input", function () {
      if (!lastPlan) return;
      renderPlan();
    });

    els.cardioEnabled.addEventListener("change", function () {
      if (lastPlan) {
        renderPlan();
      }
    });

    els.saunaEnabled.addEventListener("change", function () {
      if (els.saunaEnabled.checked) {
        els.saunaInlineRow.style.display = "flex";
        els.saunaDurationInline.value = currentSettings.saunaDuration;
        els.relaxDurationInline.value = currentSettings.relaxDuration;
        els.saunaCountInline.value = 1;
      } else {
        els.saunaInlineRow.style.display = "none";
        els.saunaSessionsContainer.style.display = "none";
        els.saunaSessionsContainer.innerHTML = "";
      }
      updateSaunaSessionsUI();
      if (lastPlan) {
        calculatePlan();
      }
    });

    // Inline Sauna-Felder
    [els.saunaDurationInline, els.relaxDurationInline, els.saunaCountInline].forEach(function (input) {
      input.addEventListener("focus", function () {
        setTimeout(() => {
          input.select();
        }, 10);
      });
      input.addEventListener("input", function () {
        updateSaunaSessionsUI();
        if (lastPlan) {
          calculatePlan();
        }
      });
    });

    els.settingsToggle.addEventListener("click", function () {
      const open = els.settingsBody.style.display === "block";
      els.settingsBody.style.display = open ? "none" : "block";
      els.settingsToggleIcon.textContent = open ? "+" : "–";
      const span = els.settingsToggle.querySelector("span");
      if (span) {
        span.textContent = open ? "Einstellungen öffnen" : "Einstellungen schließen";
      }
    });

    els.saveSettings.addEventListener("click", function () {
      saveSettings();
      showToast("Einstellungen gespeichert.", function () {
        // Einstellungen zuklappen
        els.settingsBody.style.display = "none";
        els.settingsToggleIcon.textContent = "+";
        const span = els.settingsToggle.querySelector("span");
        if (span) span.textContent = "Einstellungen öffnen";

        calculatePlan();
        const planSection = document.getElementById("planSection");
        if (planSection) {
          planSection.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    });

    els.resetDefaults.addEventListener("click", function () {
      resetDefaults();
      if (lastPlan) {
        lastPlan = null;
        els.planOutput.innerHTML =
          '<div class="message info">Standardwerte geladen. Bitte Plan erneut berechnen.</div>';
      }
    });

    // Inhalt beim Antippen in Einstellungsfeldern markieren
    const numericSettingInputs = [
      els.driveTo,
      els.driveBack,
      els.changeBefore,
      els.changeAfter,
      els.saunaDuration,
      els.relaxDuration,
      els.preSaunaShower,
      els.postSaunaShower,
      els.showerAfter,
      els.breakBetween
    ];

    numericSettingInputs.forEach(function (input) {
      input.addEventListener("focus", function () {
        setTimeout(() => {
          input.select();
        }, 10);
      });
    });

    // Init
    loadSettings();
    setDefaultTimes();
    els.ratioInfo.textContent = "erst nach der ersten Berechnung sinnvoll nutzbar";
    els.saunaInlineRow.style.display = els.saunaEnabled.checked ? "flex" : "none";
    updateSaunaSessionsUI();
  </script>
</body>
</html>
